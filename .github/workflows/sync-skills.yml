name: Sync Skills to chart-visualization-skills

on:
  push:
    branches:
      - master
      - main
    paths:
      - 'skills/**'
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      force:
        description: 'å¼ºåˆ¶åŒæ­¥ï¼ˆè·³è¿‡æ–‡ä»¶éªŒè¯ï¼‰'
        required: false
        default: 'false'

# é™åˆ¶æƒé™ï¼šåªå…è®¸ä»“åº“ç»´æŠ¤è€…æ‰‹åŠ¨è§¦å‘
permissions:
  contents: read

jobs:
  sync:
    runs-on: ubuntu-latest
    # åªåœ¨å®˜æ–¹ä»“åº“è¿è¡Œï¼Œé¿å… fork ä»“åº“æ»¥ç”¨
    if: github.repository == 'antvis/L7'
    
    steps:
      - name: Checkout source repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate files before sync
        run: |
          echo "éªŒè¯ skills ç›®å½•ä¸­çš„æ–‡ä»¶..."
          
          # æ£€æŸ¥æ˜¯å¦åªåŒ…å«å…è®¸çš„æ–‡ä»¶ç±»å‹
          ALLOWED_EXTENSIONS=("md" "json" "yml" "yaml" "txt")
          
          find skills -type f | while read file; do
            ext="${file##*.}"
            
            # æ£€æŸ¥æ˜¯å¦ä¸ºå…è®¸çš„æ‰©å±•å
            if [[ ! " ${ALLOWED_EXTENSIONS[@]} " =~ " ${ext} " ]]; then
              echo "âŒ å‘ç°ä¸å…è®¸çš„æ–‡ä»¶ç±»å‹: $file"
              echo "åªå…è®¸ä»¥ä¸‹æ–‡ä»¶ç±»å‹: ${ALLOWED_EXTENSIONS[*]}"
              exit 1
            fi
            
            # æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ 5MBï¼‰
            size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file")
            if [ $size -gt 5242880 ]; then
              echo "âŒ æ–‡ä»¶è¿‡å¤§ (>5MB): $file"
              exit 1
            fi
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å¯ç–‘å†…å®¹
            if grep -q "eval\|exec\|system\|shell_exec\|passthru" "$file"; then
              echo "âš ï¸  è­¦å‘Š: æ–‡ä»¶åŒ…å«å¯ç–‘å…³é”®å­—: $file"
              if [ "${{ github.event.inputs.force }}" != "true" ]; then
                echo "âŒ åœæ­¢åŒæ­¥ã€‚å¦‚éœ€ç»§ç»­ï¼Œè¯·ä½¿ç”¨ force å‚æ•°æ‰‹åŠ¨è§¦å‘"
                exit 1
              fi
            fi
          done
          
          echo "âœ… æ–‡ä»¶éªŒè¯é€šè¿‡"

      - name: Checkout target repository
        uses: actions/checkout@v4
        with:
          repository: antvis/chart-visualization-skills
          path: target-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync skills directory
        run: |
          # åˆ é™¤ç›®æ ‡ç›®å½•ä¸‹çš„æ—§æ–‡ä»¶
          rm -rf target-repo/l7
          
          # åˆ›å»ºç›®æ ‡ç›®å½•
          mkdir -p target-repo/l7
          
          # åªå¤åˆ¶å…è®¸çš„æ–‡ä»¶ç±»å‹
          rsync -av --include='*/' \
            --include='*.md' \
            --include='*.json' \
            --include='*.yml' \
            --include='*.yaml' \
            --include='*.txt' \
            --exclude='*' \
            skills/ target-repo/l7/
          
          # æ˜¾ç¤ºåŒæ­¥çš„æ–‡ä»¶
          echo "âœ… åŒæ­¥çš„æ–‡ä»¶:"
          find target-repo/l7 -type f | sort

      - name: Create Pull Request
        run: |
          cd target-repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰å˜åŒ–
          if [ -z "$(git status --porcelain)" ]; then
            echo "âœ… æ²¡æœ‰æ–‡ä»¶å˜åŒ–ï¼Œè·³è¿‡ PR åˆ›å»º"
            exit 0
          fi
          
          # åˆ›å»ºæ–°åˆ†æ”¯
          BRANCH_NAME="sync-l7-skills-$(date +%Y%m%d-%H%M%S)"
          git checkout -b "$BRANCH_NAME"
          
          # æäº¤å˜æ›´
          git add l7/
          git commit -m "chore: sync L7 skills from antvis/L7

          Auto-synced from https://github.com/antvis/L7/tree/${{ github.sha }}/skills
          
          Changes:
          $(git diff --staged --stat)"
          
          # æ¨é€åˆ†æ”¯
          git push origin "$BRANCH_NAME"
          
          # ä½¿ç”¨ GitHub CLI åˆ›å»º PR
          gh pr create \
            --repo antvis/chart-visualization-skills \
            --base main \
            --head "$BRANCH_NAME" \
            --title "chore: sync L7 skills - $(date +%Y-%m-%d)" \
            --body "ğŸ¤– è‡ªåŠ¨åŒæ­¥ L7 æŠ€èƒ½æ–‡æ¡£
          
          **æ¥æº**: https://github.com/antvis/L7/tree/${{ github.sha }}/skills
          **è§¦å‘è€…**: @${{ github.actor }}
          **Commit**: ${{ github.sha }}
          
          ## å˜æ›´å†…å®¹
          
          \`\`\`
          $(cd .. && git diff --stat)
          \`\`\`
          
          ## æ–‡ä»¶åˆ—è¡¨
          
          $(find l7 -type f | sort | sed 's/^/- /')
          
          ---
          
          âš ï¸ è¯·å®¡æŸ¥ä»¥ä¸‹å†…å®¹ï¼š
          - [ ] æ–‡ä»¶å†…å®¹ç¬¦åˆè§„èŒƒ
          - [ ] æ²¡æœ‰æ•æ„Ÿä¿¡æ¯
          - [ ] æ–‡æ¡£æ ¼å¼æ­£ç¡®
          
          åˆå¹¶åå°†è‡ªåŠ¨å‘å¸ƒåˆ°æŠ€èƒ½åº“ã€‚" \
            --label "automated,sync,l7"
          
          echo "âœ… PR å·²åˆ›å»º: $BRANCH_NAME"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
