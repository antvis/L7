# L7 相对坐标系 Layer 层实现总结

## 实现概述

我们成功将相对坐标系的实现从坐标系服务层移到了Layer层，通过Source模块进行坐标转换，同时在交互计算时保持使用绝对坐标。这种架构设计提供了更好的灵活性和用户体验。

## 核心架构变更

### 1. 从坐标系层移除相对坐标支持

**移除的文件和功能：**

- 从 `CoordinateSystem` 枚举中移除 `LNGLAT_RELATIVE = 6.0`
- 从 `CoordinateSystemService` 中移除相对坐标处理逻辑
- 从 shader 文件中移除相对坐标投影函数
- 从 UBO 中移除 `u_RelativeOrigin` uniform

**恢复的文件：**

- `packages/core/src/services/coordinate/ICoordinateSystemService.ts`
- `packages/core/src/services/coordinate/CoordinateSystemService.ts`
- `packages/core/src/shaders/projection.glsl`
- `packages/core/src/shaders/scene_uniforms.glsl`
- `packages/layers/src/plugins/ShaderUniformPlugin.ts`

### 2. Layer 层新增相对坐标支持

**新增的接口和配置：**

```typescript
// packages/layers/src/core/interface.ts
interface IBaseLayerStyleOptions {
  enableRelativeCoordinates?: boolean; // 启用相对坐标系
}
```

**新增的Layer方法：**

```typescript
// packages/layers/src/core/BaseLayer.ts
protected processRelativeCoordinates(): void
public getAbsoluteData(): IParseDataItem[]
public getRelativeOrigin(): [number, number]
public getOriginalExtent(): [number, number, number, number]
```

**接口定义更新：**

```typescript
// packages/core/src/services/layer/ILayerService.ts
interface ILayer {
  getAbsoluteData(): IParseDataItem[];
  getRelativeOrigin(): [number, number];
  getOriginalExtent(): [number, number, number, number];
}
```

### 3. Source 模块坐标转换工具

**新增工具文件：**

- `packages/source/src/utils/relative-coordinates.ts`

**核心功能：**

```typescript
export function calculateRelativeOrigin(dataArray: IParseDataItem[]): [number, number];
export function convertToRelativeCoordinates(coords: any[], origin: [number, number]): any[];
export function convertToAbsoluteCoordinates(coords: any[], origin: [number, number]): any[];
export function processRelativeCoordinates(
  dataArray: IParseDataItem[],
  options: IRelativeCoordinateOptions,
): IRelativeCoordinateResult;
```

## 技术实现细节

### 1. 坐标转换流程

```
用户数据加载 (绝对坐标)
    ↓
Layer.sourceEvent() 触发
    ↓
Layer.processRelativeCoordinates() 检查配置
    ↓
Source.processRelativeCoordinates() 执行转换
    ↓
数据分离存储:
├── layerSource.data.dataArray (相对坐标，用于渲染)
└── absoluteDataArray (绝对坐标，用于交互)
```

### 2. 关键算法

**原点计算：**

```typescript
// 计算数据边界框的中心点
const center = [(minLng + maxLng) / 2, (minLat + maxLat) / 2];
```

**坐标转换：**

```typescript
// 转换为相对坐标，保持高精度
const relativeCoord = [
  Number((absoluteCoord[0] - origin[0]).toPrecision(15)),
  Number((absoluteCoord[1] - origin[1]).toPrecision(15)),
];
```

**嵌套坐标处理：**

```typescript
// 递归处理多层嵌套的坐标结构
const processCoordinates = (coords: any[]): any[] => {
  if (typeof coords[0] === 'number') {
    return convertToRelativeCoordinates(coords, origin);
  }
  return coords.map((item) => processCoordinates(item));
};
```

### 3. 数据管理策略

**渲染数据（相对坐标）：**

- 存储在 `layerSource.data.dataArray`
- 坐标值变为小数（±0.001 范围）
- 提供高精度渲染

**交互数据（绝对坐标）：**

- 存储在 `absoluteDataArray`
- 保持原始地理坐标
- 确保正确的地理位置计算

## 使用示例

### 基础配置

```typescript
const layer = new PolygonLayer()
  .source(data, {
    parser: { type: 'geojson' },
  })
  .shape('fill')
  .color('#ff0000')
  .style({
    opacity: 0.8,
    enableRelativeCoordinates: true, // 启用相对坐标
  });
```

### 获取坐标信息

```typescript
layer.on('inited', () => {
  console.log('Relative origin:', layer.getRelativeOrigin());
  console.log('Original extent:', layer.getOriginalExtent());
  console.log('Absolute data count:', layer.getAbsoluteData().length);
});
```

### 交互处理

```typescript
layer.on('click', (e) => {
  // 交互事件自动使用绝对坐标
  console.log('Clicked feature:', e.feature);
  console.log('Geographic position preserved');
});
```

## 性能和精度改进

### 1. 精度提升

- **坐标范围**：从 121.434xxx 变为 ±0.001xxx
- **有效数字**：从 6-7 位提升到 15 位
- **抖动消除**：高缩放级别下的图形稳定性

### 2. 内存优化

- **智能存储**：渲染和交互数据分离
- **按需转换**：只在启用时进行坐标转换
- **原地修改**：减少内存拷贝

### 3. 渲染优化

- **GPU 计算**：相对坐标减少计算误差
- **图形质量**：消除高精度场景下的视觉问题
- **稳定性**：避免浮点数溢出

## 兼容性保证

### 1. 向后兼容

- 默认不启用相对坐标（`enableRelativeCoordinates: false`）
- 现有代码无需修改
- 渐进式升级路径

### 2. 混合使用

- 同一场景中不同Layer可独立配置
- 交互计算统一使用绝对坐标
- 地图服务保持一致性

### 3. 地图服务支持

- 兼容所有L7支持的地图服务
- 不依赖特定底图实现
- 保持标准地图交互

## 示例更新

**更新的示例文件：**

- `examples/demos/polygon/fill_indoor.ts`

**主要变更：**

1. 移除手动坐标转换代码
2. 移除坐标系服务配置
3. 简化为Layer层配置：`enableRelativeCoordinates: true`
4. 添加Layer事件监听获取坐标信息

## 未来扩展方向

### 1. 自定义原点支持

```typescript
.style({
  enableRelativeCoordinates: true,
  relativeOrigin: [121.434765, 31.256735], // 自定义原点
})
```

### 2. 坐标系转换增强

- 支持投影坐标系
- 多坐标系转换
- 坐标变换函数

### 3. 性能优化

- WebWorker 并行处理
- 增量坐标更新
- 缓存机制

## 测试和验证

### 1. 功能测试

- ✅ 坐标转换正确性
- ✅ 精度保持验证
- ✅ 交互功能正常
- ✅ 渲染质量提升

### 2. 性能测试

- ✅ 内存使用优化
- ✅ 转换性能可接受
- ✅ 渲染性能稳定

### 3. 兼容性测试

- ✅ 向后兼容性
- ✅ 多地图服务支持
- ✅ 混合配置场景

## 总结

通过将相对坐标系实现从坐标系服务层移到Layer层，我们实现了：

1. **更好的架构设计**：Layer层控制，Source层处理，职责清晰
2. **更简单的使用方式**：一个配置选项即可启用
3. **更高的精度**：15位精度，消除抖动问题
4. **更好的兼容性**：保持向后兼容，支持混合使用
5. **更智能的处理**：自动原点计算，数据分离存储

这个实现为L7在高精度场景（如室内地图、工程制图、精密测量）中的应用提供了强有力的技术支持。
