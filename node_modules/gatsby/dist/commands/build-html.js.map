{"version":3,"sources":["../../src/commands/build-html.js"],"names":["Promise","require","webpack","fs","chunk","webpackConfig","reporter","createErrorFromString","telemetry","structureWebpackErrors","runWebpack","compilerConfig","resolve","reject","run","err","stats","doBuildRenderer","program","directory","outputFile","hasErrors","panic","compilation","errors","buildRenderer","stage","parentSpan","config","deleteRenderer","rendererPath","remove","e","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","envVars","Object","entries","NODE_ENV","process","env","gatsby_executing_command","gatsby_log_level","segments","map","pageSegment","renderHTML","paths","then","tick","length","catch","doBuildPages","pagePaths","decorateEvent","siteMeasurements","pagesCount","prettyError","stack","context","buildPages","span","module","exports"],"mappings":"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","sourcesContent":["/* @flow */\nconst Promise = require(`bluebird`)\nconst webpack = require(`webpack`)\nconst fs = require(`fs-extra`)\n// const convertHrtime = require(`convert-hrtime`)\nconst { chunk } = require(`lodash`)\nconst webpackConfig = require(`../utils/webpack.config`)\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst { createErrorFromString } = require(`gatsby-cli/lib/reporter/errors`)\nconst telemetry = require(`gatsby-telemetry`)\n\nconst { structureWebpackErrors } = require(`../utils/webpack-error-utils`)\n\nconst runWebpack = compilerConfig =>\n  new Promise((resolve, reject) => {\n    webpack(compilerConfig).run((err, stats) => {\n      if (err) {\n        reject(err)\n      } else {\n        resolve(stats)\n      }\n    })\n  })\n\nconst doBuildRenderer = async (program, webpackConfig) => {\n  const { directory } = program\n  const stats = await runWebpack(webpackConfig)\n  // render-page.js is hard coded in webpack.config\n  const outputFile = `${directory}/public/render-page.js`\n  if (stats.hasErrors()) {\n    reporter.panic(\n      structureWebpackErrors(`build-html`, stats.compilation.errors)\n    )\n  }\n  return outputFile\n}\n\nconst buildRenderer = async (program, stage, { parentSpan }) => {\n  const { directory } = program\n  const config = await webpackConfig(program, directory, stage, null, {\n    parentSpan,\n  })\n  return await doBuildRenderer(program, config)\n}\n\nconst deleteRenderer = async rendererPath => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\n\nconst renderHTMLQueue = (\n  { workerPool, activity },\n  htmlComponentRendererPath,\n  pages\n) =>\n  new Promise((resolve, reject) => {\n    // We need to only pass env vars that are set programmatically in gatsby-cli\n    // to child process. Other vars will be picked up from environment.\n    const envVars = Object.entries({\n      NODE_ENV: process.env.NODE_ENV,\n      gatsby_executing_command: process.env.gatsby_executing_command,\n      gatsby_log_level: process.env.gatsby_log_level,\n    })\n\n    // const start = process.hrtime()\n    const segments = chunk(pages, 50)\n    // let finished = 0\n\n    Promise.map(\n      segments,\n      pageSegment =>\n        new Promise((resolve, reject) => {\n          workerPool\n            .renderHTML({\n              htmlComponentRendererPath,\n              paths: pageSegment,\n              envVars,\n            })\n            .then(() => {\n              // finished += pageSegment.length\n              if (activity && activity.tick) {\n                activity.tick(pageSegment.length)\n                // activity.setStatus(\n                //   `${finished}/${pages.length} ${(\n                //     finished / convertHrtime(process.hrtime(start)).seconds\n                //   ).toFixed(2)} pages/second`\n                // )\n              }\n              resolve()\n            })\n            .catch(reject)\n        })\n    )\n      .then(resolve)\n      .catch(reject)\n  })\n\nconst doBuildPages = async ({\n  rendererPath,\n  pagePaths,\n  activity,\n  workerPool,\n}) => {\n  telemetry.decorateEvent(`BUILD_END`, {\n    siteMeasurements: { pagesCount: pagePaths.length },\n  })\n\n  try {\n    await renderHTMLQueue({ workerPool, activity }, rendererPath, pagePaths)\n  } catch (e) {\n    const prettyError = await createErrorFromString(\n      e.stack,\n      `${rendererPath}.map`\n    )\n    prettyError.context = e.context\n    throw prettyError\n  }\n}\n\nconst buildPages = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}) => {\n  const rendererPath = await buildRenderer(program, stage, {\n    parentSpan: activity.span,\n  })\n  await doBuildPages({ rendererPath, pagePaths, activity, workerPool })\n  await deleteRenderer(rendererPath)\n}\n\nmodule.exports = {\n  buildPages,\n}\n"],"file":"build-html.js"}