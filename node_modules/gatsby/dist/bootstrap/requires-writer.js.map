{"version":3,"sources":["../../src/bootstrap/requires-writer.js"],"names":["_","require","path","fs","crypto","slash","store","emitter","reporter","match","paramRe","SEGMENT_POINTS","STATIC_POINTS","DYNAMIC_POINTS","SPLAT_PENALTY","ROOT_POINTS","isRootSegment","segment","isDynamic","test","isSplat","rankRoute","segmentize","reduce","score","uri","replace","split","lastHash","resetLastHash","pickComponentFields","page","pick","getComponents","pages","map","uniqBy","c","componentChunkName","value","getMatchPaths","createMatchPathEntry","index","matchPath","matchPathPages","forEach","push","length","newMatches","isInsideMatchPath","find","pageWithMatchPath","sort","a","b","order","localeCompare","createHash","matchPaths","components","update","JSON","stringify","digest","writeAll","state","program","values","newHash","syncRequires","component","join","asyncRequires","relativeComponentPath","relative","directory","writeAndMove","file","data","destination","tmp","Date","now","writeFile","then","move","overwrite","Promise","all","debouncedWriteAll","debounce","activity","activityTimer","id","start","didRequiresChange","getState","pendingActivity","end","leading","startListener","on","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst path = require(`path`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\nconst { slash } = require(`gatsby-core-utils`)\nconst { store, emitter } = require(`../redux/`)\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst { match } = require(`@reach/router/lib/utils`)\nimport { joinPath } from \"gatsby-core-utils\"\n\n// path ranking algorithm copied (with small adjustments) from `@reach/router` (internal util, not exported from the package)\n// https://github.com/reach/router/blob/28a79e7fc3a3487cb3304210dc3501efb8a50eba/src/lib/utils.js#L216-L254\nconst paramRe = /^:(.+)/\n\nconst SEGMENT_POINTS = 4\nconst STATIC_POINTS = 3\nconst DYNAMIC_POINTS = 2\nconst SPLAT_PENALTY = 1\nconst ROOT_POINTS = 1\n\nconst isRootSegment = segment => segment === ``\nconst isDynamic = segment => paramRe.test(segment)\nconst isSplat = segment => segment === `*`\n\nconst rankRoute = path =>\n  segmentize(path).reduce((score, segment) => {\n    score += SEGMENT_POINTS\n    if (isRootSegment(segment)) score += ROOT_POINTS\n    else if (isDynamic(segment)) score += DYNAMIC_POINTS\n    else if (isSplat(segment)) score -= SEGMENT_POINTS + SPLAT_PENALTY\n    else score += STATIC_POINTS\n    return score\n  }, 0)\n\nconst segmentize = uri =>\n  uri\n    // strip starting/ending slashes\n    .replace(/(^\\/+|\\/+$)/g, ``)\n    .split(`/`)\n// end of copied `@reach/router` internals\n\nlet lastHash = null\n\nconst resetLastHash = () => {\n  lastHash = null\n}\n\nconst pickComponentFields = page =>\n  _.pick(page, [`component`, `componentChunkName`])\n\nconst getComponents = pages =>\n  _(pages)\n    .map(pickComponentFields)\n    .uniqBy(c => c.componentChunkName)\n    .value()\n\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = pages => {\n  const createMatchPathEntry = (page, index) => {\n    return {\n      ...page,\n      index,\n      score: rankRoute(page.matchPath),\n    }\n  }\n\n  const matchPathPages = []\n  pages.forEach((page, index) => {\n    if (page.matchPath) {\n      matchPathPages.push(createMatchPathEntry(page, index))\n    }\n  })\n\n  // Pages can live in matchPaths, to keep them working without doing another network request\n  // we save them in matchPath. We use `@reach/router` path ranking to score paths/matchPaths\n  // and sort them so more specific paths are before less specific paths.\n  // More info in https://github.com/gatsbyjs/gatsby/issues/16097\n  // small speedup: don't bother traversing when no matchPaths found.\n  if (matchPathPages.length) {\n    const newMatches = []\n    pages.forEach((page, index) => {\n      const isInsideMatchPath = !!matchPathPages.find(\n        pageWithMatchPath =>\n          !page.matchPath && match(pageWithMatchPath.matchPath, page.path)\n      )\n\n      if (isInsideMatchPath) {\n        newMatches.push(\n          createMatchPathEntry(\n            {\n              ...page,\n              matchPath: page.path,\n            },\n            index\n          )\n        )\n      }\n    })\n    // Add afterwards because the new matches are not relevant for the existing search\n    matchPathPages.push(...newMatches)\n  }\n\n  return matchPathPages\n    .sort((a, b) => {\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificity is the same we do lexigraphic comparison of path to ensure\n      // deterministic order regardless of order pages where created\n      return a.matchPath.localeCompare(b.matchPath)\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\nconst createHash = (matchPaths, components) =>\n  crypto\n    .createHash(`md5`)\n    .update(JSON.stringify({ matchPaths, components }))\n    .digest(`hex`)\n\n// Write out pages information.\nconst writeAll = async state => {\n  // console.log(`on requiresWriter progress`)\n  const { program } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages)\n\n  const newHash = createHash(matchPaths, components)\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    // console.log(`on requiresWriter END1`)\n    return false\n  }\n\n  lastHash = newHash\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `const { hot } = require(\"react-hot-loader/root\")\n\n// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": hot(preferDefault(require(\"${joinPath(\n          c.component\n        )}\")))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(c => {\n      // we need a relative import path to keep contenthash the same if directory changes\n      const relativeComponentPath = path.relative(\n        path.join(program.directory, `.cache`),\n        c.component\n      )\n\n      return `  \"${c.componentChunkName}\": () => import(\"${slash(\n        relativeComponentPath\n      )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    })\n    .join(`,\\n`)}\n}\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  await Promise.all([\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(`match-paths.json`, JSON.stringify(matchPaths, null, 4)),\n  ])\n\n  return true\n}\n\nconst debouncedWriteAll = _.debounce(\n  async () => {\n    const activity = reporter.activityTimer(`write out requires`, {\n      id: `requires-writer`,\n    })\n    activity.start()\n    const didRequiresChange = await writeAll(store.getState())\n    if (didRequiresChange) {\n      reporter.pendingActivity({ id: `webpack-develop` })\n    }\n    activity.end()\n  },\n  500,\n  {\n    // using \"leading\" can cause double `writeAll` call - particularly\n    // when refreshing data using `/__refresh` hook.\n    leading: false,\n  }\n)\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nconst startListener = () => {\n  emitter.on(`CREATE_PAGE`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, () => {\n    reporter.pendingActivity({ id: `requires-writer` })\n    debouncedWriteAll()\n  })\n}\n\nmodule.exports = {\n  writeAll,\n  resetLastHash,\n  startListener,\n}\n"],"file":"requires-writer.js"}